import { load } from "@tauri-apps/plugin-store";
import type { EndpointConfig } from "./state";
import { DEFAULT_ENDPOINT, DEFAULT_MCP_COMMAND, DEFAULT_VLM_ENABLED } from "./state";

export interface PersistedSettings {
  plannerConfig: EndpointConfig;
  agentConfig: EndpointConfig;
  vlmConfig: EndpointConfig;
  vlmEnabled: boolean;
  mcpCommand: string;
  maxRepairAttempts: number;
}

const SETTINGS_DEFAULTS: PersistedSettings = {
  plannerConfig: DEFAULT_ENDPOINT,
  agentConfig: DEFAULT_ENDPOINT,
  vlmConfig: DEFAULT_ENDPOINT,
  vlmEnabled: DEFAULT_VLM_ENABLED,
  mcpCommand: DEFAULT_MCP_COMMAND,
  maxRepairAttempts: 3,
};

export async function loadSettings(): Promise<PersistedSettings> {
  const store = await load("settings.json", { autoSave: false, defaults: {} });

  // Backward compat: if legacy orchestratorConfig exists, use it as fallback for new configs
  const legacyConfig = await store.get<EndpointConfig>("orchestratorConfig");
  const fallback = legacyConfig ?? SETTINGS_DEFAULTS.agentConfig;

  const plannerConfig = await store.get<EndpointConfig>("plannerConfig");
  const agentConfig = await store.get<EndpointConfig>("agentConfig");
  const vlmConfig = await store.get<EndpointConfig>("vlmConfig");
  const vlmEnabled = await store.get<boolean>("vlmEnabled");
  const mcpCommand = await store.get<string>("mcpCommand");
  const maxRepairAttempts = await store.get<number>("maxRepairAttempts");
  return {
    plannerConfig: plannerConfig ?? fallback,
    agentConfig: agentConfig ?? fallback,
    vlmConfig: vlmConfig ?? SETTINGS_DEFAULTS.vlmConfig,
    vlmEnabled: vlmEnabled ?? SETTINGS_DEFAULTS.vlmEnabled,
    mcpCommand: mcpCommand ?? SETTINGS_DEFAULTS.mcpCommand,
    maxRepairAttempts: maxRepairAttempts ?? SETTINGS_DEFAULTS.maxRepairAttempts,
  };
}

export async function saveSetting<K extends keyof PersistedSettings>(
  key: K,
  value: PersistedSettings[K],
): Promise<void> {
  const store = await load("settings.json", { autoSave: false, defaults: {} });
  await store.set(key, value);
  await store.save();
}

export function toEndpoint(c: EndpointConfig) {
  return {
    base_url: c.baseUrl,
    model: c.model,
    api_key: c.apiKey || null,
  };
}
